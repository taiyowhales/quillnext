---
alwaysApply: true
---
## 1. Family Blueprint Wizard

### What It Does

The Family Blueprint Wizard is the **foundational onboarding experience** that captures a family's educational philosophy, schedule, and teaching preferences. It's the first step users take after signing up, and it provides the context that personalizes all subsequent features.

### How It Works

**Three-Step Progressive Wizard:**

1. **Classroom Setup** (Step 1)
   - Create classroom(s) with names
   - Add instructor profiles (name, role)
   - Set instructor PIN for secure access
   - PIN is hashed with bcrypt for security

2. **Schedule Configuration** (Step 2)
   - Define school year dates (start/end)
   - Set weekly schedule (days of week, hours)
   - Add holidays and breaks
   - Configure special scheduling rules

3. **Environment Preferences** (Step 3)
   - Select educational philosophy:
     - Classical Education
     - Charlotte Mason
     - Montessori
     - Unschooling
     - Traditional
     - Eclectic
   - Choose faith background:
     - Protestant
     - Catholic
     - Secular
     - Other
   - Set other environmental preferences

**Technical Implementation:**
- Uses **progressive saving** - each step saves independently via Server Actions
- State managed with `nuqs` for URL-based step tracking (`?step=schedule`)
- Can restore progress from database if user returns later
- Zod schemas validate all inputs before saving
- Stores data in `Classroom`, `ClassroomInstructor`, and related tables

**Data Stored:**
- `Classroom` - Classroom metadata and preferences
- `ClassroomInstructor` - Instructor profiles with hashed PINs
- `ClassroomSchedule` - Weekly schedule configuration
- `Holiday` - School breaks and holidays

### Why It Matters

The Family Blueprint provides **context for all AI-generated content**:
- Educational philosophy influences content style (e.g., Classical emphasizes Socratic dialogue)
- Faith background affects content selection (e.g., Bible integration in Protestant courses)
- Schedule determines course pacing and auto-fill capabilities
- Instructor preferences shape how content is presented

---

## 2. Student Personality Assessment

### What It Does

The Student Personality Assessment uses **AI semantic profiling** to understand each student's learning style, communication preferences, and motivational drivers. Instead of hardcoded scoring, it uses Gemini 3 Pro to analyze questionnaire responses and generate a nuanced learning profile.

### How It Works

**Assessment Flow:**

1. **Questionnaire Presentation**
   - Multi-question personality assessment
   - Questions cover learning preferences, communication style, motivation, etc.
   - Answers stored as key-value pairs

2. **AI Analysis**
   - All answers sent to `generateStudentProfile()` function
   - Uses Vercel AI SDK `generateObject` with Zod schema
   - Gemini 3 Pro analyzes responses semantically
   - Generates structured profile with:
     - `primaryDrivers` - Top 3 motivators (e.g., "Autonomy", "Physical Touch", "Verbal Praise")
     - `communicationStyle` - How to communicate effectively (Direct, Gentle, Socratic, Enthusiastic, Supportive)
     - `suggestedSystemPrompt` - 2-3 sentence instruction for AI tutor on how to speak to this student
     - `strengths` - Key learning strengths and preferences
     - `learningPreferences` - Pace, structure, collaboration preferences
     - `encouragementStyle` - Best way to encourage this student

3. **Profile Storage**
   - Results stored in `LearnerProfile.personalityData` (JSON)
   - `suggestedSystemPrompt` used in all future AI interactions
   - Profile accessible for content personalization

**Technical Implementation:**
- Uses Gemini 3 Pro for highest quality analysis
- Zod schema ensures type-safe output
- Single assessment flow (no separate API calls)
- Profile automatically injected into all AI prompts

**Data Stored:**
- `LearnerProfile.personalityData` - Full personality profile (JSON)
- `LearnerProfile.learningStyleData` - Learning style preferences (optional separate assessment)

### Why It Matters

The personality profile enables **true personalization**:
- AI-generated content adapts to student's communication style
- Quizzes and worksheets match learning preferences
- Feedback uses appropriate encouragement style
- Course pacing adjusts to student's pace preference
- All AI interactions respect the `suggestedSystemPrompt`

---

## 3. Living Library

### What It Does

The Living Library is a **semantic search system** for educational content (books and videos). It uses AI vision for book scanning, pgvector for intelligent search, and generates embeddings for content discovery.

### How It Works

**Book Management:**

1. **Book Scanning**
   - User uploads book cover image or uses camera
   - Gemini Vision API (GPT-4o) extracts:
     - ISBN (if visible)
     - Title and author
     - Publication details
   - Structured extraction using `generateObject`

2. **Content Extraction**
   - Optional: Extract full text from book (PDF upload)
   - Generate summary and key points
   - Extract educational metadata (subject, grade level, topics)

3. **Vector Embeddings**
   - Generate embedding using OpenAI `text-embedding-3-small` (1536 dimensions)
   - Store in `Book.embedding` field (pgvector)
   - Enables semantic search

**Semantic Search:**

- User searches with natural language: "fractions for 5th grade"
- Query converted to embedding
- Vector similarity search finds relevant books
- Results ranked by semantic similarity (cosine distance)
- Can find books even if exact keywords don't match

**Video Resources:**

- YouTube URL support (requires Gemini 3 Pro)
- Extract transcript and summary
- Generate key learning points
- Link to subjects/strands for curriculum integration

**Technical Implementation:**
- `searchBooks()` - Semantic search using pgvector
- `generateBookEmbedding()` - Create and store embeddings
- `findSimilarBooks()` - "If you liked this" recommendations
- Background jobs for embedding generation (Inngest or similar)

**Data Stored:**
- `Book` - Book metadata with `embedding` field
- `VideoResource` - YouTube videos with transcripts
- `Resource` - Generated content linked to books/videos

### Why It Matters

The Living Library provides **content sources** for:
- Course Builder can suggest books for units
- Generators can reference book content in prompts
- Students can discover related materials
- Instructors can find curriculum-aligned resources
- Semantic search finds content even without exact matches

---

## 4. Inkling Toolkit/Generators

### What It Does

The Inkling Toolkit is a **unified AI content generation system** that creates educational materials (quizzes, worksheets, lesson plans, rubrics, etc.) with full context awareness. It uses Generative UI to stream interactive React components instead of plain text.

### How It Works

**Tool Selection:**

1. **Context-Aware Tool Discovery**
   - System knows current course/strand/subject
   - Calls `trpc.curriculum.getAvailableTools({ strandId })`
   - Returns specialized tools for that strand (e.g., "Timeline Generator" for History)
   - Hides irrelevant tools (Smart Tooling)

2. **Tool Configuration**
   - Each tool has dynamic form fields (from ResourceKind YAML)
   - User fills in tool-specific inputs
   - Form validated with Zod schemas

3. **Content Generation**
   - Calls `generateLearningTool()` Server Action
   - Uses `buildCompletePrompt()` to inject full context:
     - Academic Spine hierarchy (Subject → Strand → Topic → Objective)
     - Student personality profile
     - Family educational philosophy
     - User's specific instruction
   - Model selection based on task:
     - Gemini 3 Pro for complex content
     - Gemini 2.5 Flash for most generation
     - Gemini 2.5 Flash-Lite for simple tasks
   - Automatically upgrades to Gemini 3 Pro if YouTube URLs detected

4. **Generative UI Streaming**
   - Uses Vercel AI SDK `streamUI`
   - Streams React Components (not text)
   - Shows loading states during generation
   - Yields interactive components (QuizCard, WorksheetCard, etc.)
   - Components are immediately usable (no parsing needed)

**Available Tools:**

- Quiz Generator - Interactive quizzes with multiple choice
- Worksheet Generator - Practice problems and exercises
- Lesson Plan Generator - Structured lesson plans
- Rubric Generator - Grading rubrics
- Timeline Generator - Historical timelines (History strand)
- Primary Source Analysis - Document analysis (History strand)
- Writing Assignment Generator - Essay prompts and instructions
- And more (17+ tools, context-dependent)

**Technical Implementation:**
- `generateLearningTool()` - Main Server Action
- Tool definitions as Zod schemas
- `streamUI` for component streaming
- Automatic model selection based on task complexity
- YouTube video detection and model upgrade

**Data Stored:**
- `Resource` - Generated content with metadata
- `ResourceAssignment` - Links resources to activities/courses
- `BookGeneratedMaterial` / `VideoGeneratedMaterial` - Lineage tracking

### Why It Matters

The Inkling Toolkit is the **core content creation engine**:
- Generates personalized content based on student and family context
- Respects educational philosophy and faith background
- Aligns with Academic Spine objectives
- Creates interactive components (not just text)
- Context-aware tool selection reduces cognitive load
- All content is immediately usable (no manual formatting)

---

## 5. Course Builder

### What It Does

The Course Builder is a **visual curriculum design tool** that lets instructors create structured courses with units, modules, lessons, and activities. It includes AI co-pilot assistance, auto-fill from Academic Spine, and automatic pacing calculations.

### How It Works

**Course Structure:**

1. **Course Creation**
   - Select subject and strand
   - Choose grade band
   - Set course dates (or auto-calculate from Family Blueprint schedule)
   - Define course metadata

2. **Syllabus Builder**
   - Drag-and-drop interface (dnd-kit)
   - Hierarchical structure:
     - **Unit** (top level)
       - **Module** (middle level)
         - **Section/Chapter** (optional)
           - **Lesson** (bottom level)
   - Each block can have:
     - Title and description
     - Alignment to Academic Spine (Topic/Subtopic)
     - Position in sequence

3. **Activity Management**
   - Add activities to lessons:
     - Reading assignments
     - Writing tasks
     - Discussions
     - Projects
     - Labs
     - Worksheets
   - Link activities to:
     - Resources from Living Library (books/videos)
     - Generated content from Inkling Toolkit
     - Learning Objectives

4. **AI Co-Pilot**
   - Uses Vercel AI SDK `useObject` for structured suggestions
   - Can suggest:
     - Course structure based on objectives
     - Activity types for lessons
     - Resource recommendations
     - Pacing adjustments
   - Respects Family Blueprint and student profiles

5. **Auto-Fill Features**
   - **Objective Sequencing:**
     - Select objectives from Academic Spine
     - `autoFillCourseSchedule()` distributes across weeks
     - Uses `sortOrder` and `gradeLevel` for proper sequencing
     - Respects Family Blueprint schedule (school days, holidays)

   - **Pacing Calculation:**
     - `calculateCoursePacing()` uses classroom schedule
     - Accounts for holidays and breaks
     - Distributes objectives across available school days
     - Shows preview before saving

6. **YouTube Video Integration**
   - Users can add YouTube links to activities
   - System automatically detects and uses Gemini 3 Pro
   - Extracts video content for course context
   - Generates related materials (quizzes, summaries)

**Technical Implementation:**
- `calculateCoursePacing()` - Schedule calculation
- `autoFillCourseSchedule()` - Objective distribution
- Drag-and-drop with dnd-kit
- AI co-pilot with `useObject`
- YouTube video processing with Gemini 3 Pro

**Data Stored:**
- `Course` - Course metadata
- `CourseBlock` - Hierarchical structure (recursive)
- `Activity` - Lesson activities
- `ActivityObjective` - Links activities to objectives
- `ResourceAssignment` - Links resources to activities

### Why It Matters

The Course Builder is the **central hub** for curriculum design:
- Visual, intuitive interface (no coding required)
- AI assistance reduces planning time
- Auto-fill ensures proper objective sequencing
- Automatic pacing respects family schedule
- Integrates all other features (Library, Generators, Students)
- YouTube videos automatically processed and integrated
- Full Academic Spine alignment

---

## 6. Inkling Grading

### What It Does

Inkling Grading is an **AI-assisted assessment system** that provides structured grading with rubrics, generates personalized feedback, and suggests remedial resources based on student performance.

### How It Works

**Grading Flow:**

1. **Rubric Application**
   - Instructor selects or creates rubric
   - Rubric can be:
     - AI-generated (from Inkling Toolkit)
     - Manually created
     - Linked to learning objectives
   - Rubric validated with Zod schema before use

2. **Work Submission**
   - Student submits work (text, file upload, etc.)
   - Work stored in `AssessmentAttempt`
   - Linked to assessment and student

3. **Grading Process**
   - Instructor views student work
   - Applies rubric criteria
   - Can use AI assistance for:
     - Initial score suggestions
     - Feedback generation
     - Error identification

4. **Feedback Generation**
   - AI generates personalized feedback using:
     - Student personality profile (communication style)
     - Rubric criteria
     - Work content analysis
   - Feedback respects student's `suggestedSystemPrompt`
   - Uses appropriate encouragement style

5. **Remedial Suggestions**
   - System analyzes performance gaps
   - Suggests resources from:
     - Living Library (books/videos)
     - Generated content (targeted practice)
     - Related objectives for review
   - Links to specific activities for improvement

**Grading Strategies:**

- **Holistic Grading** - Overall assessment
- **Analytical Grading** - Criterion-by-criterion
- **Standards-Based** - Linked to learning objectives
- **Growth-Focused** - Emphasizes improvement

**Technical Implementation:**
- Structured outputs with Zod schemas
- Rubric validation before grading
- AI feedback generation with context injection
- Remedial resource matching

**Data Stored:**
- `Assessment` - Assessment definitions
- `AssessmentAttempt` - Student submissions
- `AssessmentGrade` - Grading results
- `Rubric` - Grading rubrics
- `Feedback` - AI-generated feedback

### Why It Matters

Inkling Grading completes the **learning cycle**:
- Structured, consistent grading
- Personalized feedback that respects student communication style
- Actionable remedial suggestions
- Tracks student progress over time
- Links back to course objectives
- Provides data for course improvement

---

## How The Features Work Together

### The Complete Flow

```
1. Family Blueprint Wizard
   ↓ (provides context)
   
2. Student Personality Assessment
   ↓ (provides personalization)
   
3. Living Library
   ↓ (provides content sources)
   
4. Course Builder
   ↓ (uses Library + Generators + Students)
   
5. Inkling Toolkit/Generators
   ↓ (generates content for courses)
   
6. Inkling Grading
   ↓ (assesses student work)
   (feeds back to Course Builder for improvement)
```

### Integration Points

#### 1. Family Blueprint → All Features

**Provides Context For:**
- **Generators:** Educational philosophy shapes content style
- **Course Builder:** Schedule determines pacing calculations
- **Grading:** Faith background influences feedback tone
- **All AI:** Philosophy and preferences in every prompt

**Example:**
```
Classical Education family → 
  Generators create Socratic dialogue questions →
    Course Builder suggests discussion activities →
      Grading emphasizes reasoning over memorization
```

#### 2. Student Personality → Content Generation

**Personalizes:**
- **Generators:** Content matches communication style
- **Course Builder:** Activities align with learning preferences
- **Grading:** Feedback uses appropriate encouragement style
- **All AI:** `suggestedSystemPrompt` in every interaction

**Example:**
```
Student with "Gentle" communication style + "slow" pace →
  Generators create step-by-step worksheets →
    Course Builder suggests extended time for activities →
      Grading provides supportive, detailed feedback
```

#### 3. Living Library → Course Builder & Generators

**Provides Content For:**
- **Course Builder:** Books/videos suggested for units
- **Generators:** Content can reference library materials
- **Grading:** Remedial resources from library

**Example:**
```
History course on Civil War →
  Living Library suggests "A People's History" →
    Course Builder links book to unit →
      Generators create primary source analysis using book →
        Grading suggests book chapters for struggling students
```

#### 4. Academic Spine → Course Builder & Generators

**Enables:**
- **Course Builder:** Auto-fill with sequenced objectives
- **Generators:** Context-aware content aligned to objectives
- **Smart Tooling:** Tools adapt to current strand/subject

**Example:**
```
History strand selected →
  Course Builder shows History-specific objectives →
    Generators show "Timeline Generator" (not generic tools) →
      Content aligns to specific learning objectives
```

#### 5. Generators → Course Builder

**Creates Content For:**
- **Course Builder:** Generated resources linked to activities
- **Activities:** Quizzes, worksheets, lesson plans assigned
- **Lineage Tracking:** Knows which book/video generated content

**Example:**
```
Course Builder activity "Fractions Quiz" →
  Generators create personalized quiz →
    Quiz linked to activity →
      Student completes quiz →
        Grading assesses performance
```

#### 6. Grading → Course Improvement

**Feeds Back To:**
- **Course Builder:** Performance data suggests adjustments
- **Generators:** Creates targeted remedial content
- **Living Library:** Suggests additional resources

**Example:**
```
Multiple students struggle with fractions →
  Grading identifies pattern →
    Generators create additional practice worksheets →
      Course Builder adds review lesson →
        Living Library suggests supplementary books
```

### Data Flow Diagram

```
┌─────────────────────┐
│ Family Blueprint    │──┐
│ (Context)           │  │
└─────────────────────┘  │
                         │
┌─────────────────────┐  │    ┌─────────────────────┐
│ Student Personality │──┼───→│  Prompt Builder     │
│ (Personalization)   │  │    │  (Context Injection)│
└─────────────────────┘  │    └─────────────────────┘
                         │              │
┌─────────────────────┐  │              │
│ Academic Spine      │──┼──────────────┘
│ (Standards)         │  │
└─────────────────────┘  │
                         │
                         │    ┌─────────────────────┐
                         └───→│  Inkling Generators │
                              │  (Content Creation) │
                              └─────────────────────┘
                                      │
┌─────────────────────┐               │
│ Living Library      │───────────────┘
│ (Content Sources)   │
└─────────────────────┘
         │
         │
         ↓
┌─────────────────────┐
│ Course Builder      │
│ (Curriculum Design) │
└─────────────────────┘
         │
         │
         ↓
┌─────────────────────┐
│ Inkling Grading     │
│ (Assessment)        │
└─────────────────────┘
         │
         │ (feedback loop)
         ↓
    Course Improvement
```

### Context Injection Example

When generating a quiz, the system automatically includes:

1. **Academic Spine Context:**
   ```
   Subject: Mathematics
   Strand: Number & Operations
   Topic: Fractions
   Objective: "Add and subtract fractions with unlike denominators"
   Grade Level: 5
   Complexity: Application (Bloom's Level 3)
   ```

2. **Student Context:**
   ```
   Name: Sarah
   Communication Style: Gentle
   Learning Pace: Moderate
   Primary Driver: Verbal Praise
   Suggested System Prompt: "Speak to Sarah in a gentle, encouraging 
   manner. She responds well to verbal praise and needs clear, 
   step-by-step explanations."
   ```

3. **Family Context:**
   ```
   Educational Philosophy: Classical Education
   Faith Background: Protestant
   Schedule: 4 days/week, 6 hours/day
   ```

4. **User Instruction:**
   ```
   "Create a quiz about adding fractions"
   ```

**Result:** AI generates a quiz that:
- Aligns to the specific learning objective
- Uses gentle, encouraging language
- Provides step-by-step guidance
- Includes appropriate complexity for grade 5
- Respects Classical Education approach
- Can be immediately used (no formatting needed)

---

## Key Architectural Principles

### 1. No Blank Canvases

Every feature provides scaffolding:
- **Course Builder:** Auto-fill with objectives
- **Generators:** Context-aware tool suggestions
- **Grading:** Rubric templates
- **Library:** Semantic search finds relevant content

### 2. Progressive Enhancement

Data saves incrementally:
- **Family Blueprint:** Each step saves independently
- **Course Builder:** Blocks save as created
- **Generators:** Content saves immediately
- **Grading:** Feedback saves progressively

### 3. Context Injection

All AI interactions include full context:
- Academic Spine hierarchy
- Student personality profile
- Family educational philosophy
- Current course/strand context

### 4. Type Safety First

Zod schemas validate at boundaries:
- Form inputs
- API requests
- Database writes
- AI outputs

### 5. Smart Tooling

Tools adapt to context:
- Show relevant tools for current strand
- Hide irrelevant options
- Suggest next actions
- Learn from usage patterns

---

## Technology Stack

### Core Framework
- **Next.js 16** (App Router) - React framework
- **TypeScript** - Type safety
- **tRPC** - Type-safe API layer
- **Prisma 7** - Database ORM
- **PostgreSQL** - Database with pgvector

### AI & ML
- **Gemini 3 Pro** - Advanced reasoning, YouTube videos
- **Gemini 2.5 Pro** - Complex tasks
- **Gemini 2.5 Flash** - Most content generation
- **Gemini 2.5 Flash-Lite** - Simple tasks
- **OpenAI Embeddings** - Vector search (text-embedding-3-small)
- **Vercel AI SDK** - AI integration (`generateObject`, `streamUI`)

### State Management
- **TanStack Query** - Server state (tRPC)
- **nuqs** - URL state (wizard steps)
- **Zustand** - Client UI state (minimal)
- **Server Actions** - Form mutations

### UI & Styling
- **Tailwind CSS v4** - Styling
- **Shadcn/UI** - Component library
- **React Hook Form** - Form management
- **Zod** - Schema validation

---

## Summary

Quill & Compass has six features that form a **complete educational ecosystem**:

1. **Family Blueprint** sets the foundation with educational philosophy and schedule
2. **Student Personality** enables true personalization
3. **Living Library** provides content sources
4. **Inkling Generators** creates personalized educational materials
5. **Course Builder** designs structured curricula
6. **Inkling Grading** completes the cycle with assessment and feedback

All features work together through:
- **Shared context** (Family Blueprint, Student Profiles, Academic Spine)
- **Context injection** in all AI prompts
- **Data relationships** (Resources → Activities → Courses → Students)
- **Feedback loops** (Grading → Course Improvement)

The result is a **cohesive, intelligent system** that adapts to each family's needs, personalizes for each student, and creates curriculum-aligned, engaging educational content.

---